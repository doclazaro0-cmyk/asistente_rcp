<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RCP Pro v9 - Limpio</title>
    <style>
        body { background: #000; color: white; font-family: -apple-system, sans-serif; margin: 0; padding: 10px; }
        #app { max-width: 450px; margin: auto; }
        
        #history-section { background: #111; border: 1px solid #333; border-radius: 10px; padding: 10px; margin-bottom: 15px; max-height: 160px; overflow-y: auto; }
        .history-card { background: #1a1a1a; padding: 8px; border-radius: 5px; margin-bottom: 5px; border-left: 4px solid #2ecc71; font-size: 0.75rem; }
        
        #total-clock { font-size: 4rem; font-weight: bold; font-family: monospace; text-align: center; display: block; }
        .cycle-box { background: #0a0a0a; border: 2px solid #444; border-radius: 20px; padding: 15px; margin: 10px 0; text-align: center; }
        #cycle-clock { font-size: 5rem; font-weight: bold; color: #00ff00; font-family: monospace; line-height: 1; }

        #live-log { background: #050505; border: 1px solid #3498db; height: 220px; overflow-y: auto; border-radius: 10px; padding: 10px; }
        .log-entry { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #111; }
        .log-txt { color: #3498db; font-weight: bold; text-transform: uppercase; font-size: 1rem; }

        button { width: 100%; padding: 20px; font-size: 1.3rem; border-radius: 15px; border: none; font-weight: bold; cursor: pointer; margin-top: 10px; }
        #start-btn { background: #27ae60; color: white; }
        #stop-btn { background: #c0392b; color: white; }
        #save-area { background: #111; padding: 15px; border-radius: 15px; margin-top: 10px; border: 1px solid #f1c40f; }
        
        input { width: 90%; padding: 12px; margin-bottom: 10px; background: #000; border: 1px solid #444; color: white; border-radius: 8px; }
        .label { font-size: 0.7rem; color: #666; text-transform: uppercase; display: block; text-align: center; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="app">
    <div id="history-section">
        <span class="label">Historial de Turno (24h)</span>
        <div id="history-list"></div>
    </div>

    <div id="total-clock">00:00</div>
    <span class="label">Tiempo de Reanimación</span>

    <div class="cycle-box">
        <div id="cycle-clock">02:00</div>
        <span id="mic-status" class="label">Escucha Automática Lista</span>
    </div>

    <div id="live-log"></div>

    <button id="start-btn">INICIAR REANIMACIÓN</button>
    <button id="stop-btn" class="hidden">DETENER RCP</button>

    <div id="save-area" class="hidden">
        <input type="text" id="p-name" placeholder="ID Paciente / Cama">
        <button id="save-confirm" style="background:#2ecc71;">GUARDAR EN BITÁCORA</button>
        <button onclick="location.reload()" style="background:#444;">DESCARTAR / NUEVO</button>
    </div>
</div>

<script>
let totalSec = 0, isRunning = false, logData = [], wakeLock = null;
let tMain, tCycle, tBeep, recognition;
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

const MEDICAMENTOS = [
    { keys: ['adrena', 'epinef'], l: 'ADRENALINA 1mg' },
    { keys: ['amioda'], l: 'AMIODARONA' },
    { keys: ['atropi'], l: 'ATROPINA' },
    { keys: ['cardiov', 'cardiovier', 'sincroniz'], l: 'CARDIOVERSIÓN' },
    { keys: ['desfibri', 'descarga', 'choque', 'dispara'], l: 'DESFIBRILACIÓN' },
    { keys: ['máximo', 'tope', 'full', 'max'], l: 'DESCARGA MÁXIMA (300J)' },
    { keys: ['lidoca'], l: 'LIDOCAÍNA' },
    { keys: ['bicarbo'], l: 'BICARBONATO' },
    { keys: ['gluconato', 'calcio'], l: 'GLUC. CALCIO' }
];

if ('webkitSpeechRecognition' in window) {
    recognition = new webkitSpeechRecognition();
    recognition.continuous = true;
    recognition.lang = 'es-ES';
    recognition.onresult = (e) => {
        const text = e.results[e.results.length - 1][0].transcript.toLowerCase();
        MEDICAMENTOS.forEach(m => {
            if (m.keys.some(k => text.includes(k))) registrar(m.l);
        });
    };
    recognition.onend = () => { if(isRunning) recognition.start(); };
}

function registrar(label) {
    const time = document.getElementById('total-clock').innerText;
    // Evitar duplicados rápidos (misma orden en menos de 2 segundos)
    if(logData.length > 0 && logData[logData.length-1].e === label && totalSec - logData[logData.length-1].s < 2) return;

    logData.push({ t: time, e: label, s: totalSec });
    const div = document.createElement('div');
    div.className = 'log-entry';
    div.innerHTML = `<span class="log-txt">${label}</span><span style="color:#666;">Min ${time}</span>`;
    document.getElementById('live-log').prepend(div);
}

function playMedBeep() {
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.connect(g); g.connect(audioCtx.destination);
    o.frequency.setValueAtTime(800, audioCtx.currentTime); 
    g.gain.setValueAtTime(0.1, audioCtx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.05);
    o.start(); o.stop(audioCtx.currentTime + 0.06);
}

document.getElementById('start-btn').onclick = async () => {
    isRunning = true;
    if (audioCtx.state === 'suspended') await audioCtx.resume();
    if ('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen');
    
    document.getElementById('start-btn').classList.add('hidden');
    document.getElementById('stop-btn').classList.remove('hidden');
    document.getElementById('mic-status').innerText = "● MICROFONO ACTIVO";
    document.getElementById('mic-status').style.color = "#e74c3c";
    
    if(recognition) recognition.start();

    tMain = setInterval(() => {
        totalSec++;
        let m = Math.floor(totalSec/60).toString().padStart(2,'0');
        let s = (totalSec%60).toString().padStart(2,'0');
        document.getElementById('total-clock').innerText = `${m}:${s}`;
    }, 1000);

    const ciclo = () => {
        let s = 120;
        tBeep = setInterval(playMedBeep, 545);
        tCycle = setInterval(() => {
            s--;
            let cm = Math.floor(s/60).toString().padStart(2,'0');
            let cs = (s%60).toString().padStart(2,'0');
            document.getElementById('cycle-clock').innerText = `${cm}:${cs}`;
            if(s <= 0) {
                clearInterval(tCycle); clearInterval(tBeep);
                window.speechSynthesis.speak(new SpeechSynthesisUtterance("Cambio. Evalúe ritmo."));
                setTimeout(() => { if(isRunning) ciclo(); }, 5000);
            }
        }, 1000);
    };
    ciclo();
};

document.getElementById('stop-btn').onclick = () => {
    isRunning = false;
    clearInterval(tMain); clearInterval(tCycle); clearInterval(tBeep);
    if(recognition) recognition.stop();
    if(wakeLock) wakeLock.release();
    document.getElementById('stop-btn').classList.add('hidden');
    document.getElementById('save-area').classList.remove('hidden');
};

document.getElementById('save-confirm').onclick = () => {
    const name = document.getElementById('p-name').value || "S/N";
    const session = { id: Date.now(), n: name, d: document.getElementById('total-clock').innerText, ev: logData };
    let h = JSON.parse(localStorage.getItem('rcp_v9') || "[]");
    h.push(session);
    localStorage.setItem('rcp_v9', JSON.stringify(h.filter(x => x.id > Date.now() - 86400000)));
    renderH();
    document.getElementById('save-area').innerHTML = "<p style='color:#2ecc71; text-align:center;'>✓ Registro Guardado</p><button onclick='location.reload()'>NUEVA RCP</button>";
};

function renderH() {
    const h = JSON.parse(localStorage.getItem('rcp_v9') || "[]");
    document.getElementById('history-list').innerHTML = h.reverse().map(x => `
        <div class="history-card">
            <b>${x.n}</b> | Duración: ${x.d} 
            <details style="margin-top:5px; color:#666;">
                <summary>Ver Detalles</summary>
                ${x.ev.map(e => `• [${e.t}] ${e.e}`).join('<br>')}
            </details>
        </div>
    `).join('');
}
renderH();
</script>
</body>
</html>
