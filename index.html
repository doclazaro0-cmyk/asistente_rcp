<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RCP Pro - Registro & Descargas</title>
    <style>
        body { background: #000; color: white; font-family: -apple-system, sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        #app { text-align: center; width: 95%; max-width: 450px; padding: 10px; }
        #total-clock { font-size: 3.2rem; font-weight: bold; font-family: monospace; line-height: 1; }
        .cycle-container { background: #0a0a0a; padding: 15px; border-radius: 20px; margin: 10px 0; border: 4px solid #222; }
        #cycle-clock { font-size: 5.5rem; font-weight: bold; color: #00ff00; font-family: monospace; line-height: 1; }
        
        .log-panel { background: #111; border-radius: 12px; padding: 10px; margin-top: 10px; text-align: left; border: 1px solid #333; max-height: 160px; overflow-y: auto; }
        .log-item { border-bottom: 1px solid #222; padding: 6px 0; font-size: 0.85rem; display: flex; justify-content: space-between; }
        .log-name { color: #3498db; font-weight: bold; text-transform: uppercase; }
        .log-time { color: #888; font-family: monospace; }
        
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; margin-top: 10px; }
        .stat-box { background: #111; padding: 8px; border-radius: 8px; border: 1px solid #222; }
        .stat-label { color: #666; font-size: 0.55rem; text-transform: uppercase; display: block; margin-bottom: 3px; }
        .stat-val { font-weight: bold; font-size: 1.1rem; color: #fff; }
        #res-descargas { color: #e74c3c; } /* Rojo para resaltar descargas */

        button { width: 100%; padding: 18px; font-size: 1.3rem; border-radius: 12px; border: none; cursor: pointer; font-weight: bold; margin-top: 8px; }
        #start-btn { background: #27ae60; color: white; }
        #stop-btn { background: #c0392b; color: white; }
        #copy-btn { background: #f39c12; color: white; font-size: 1rem; }
        #reset-btn { background: #333; color: #aaa; font-size: 1rem; }
        
        .status-bar { font-size: 0.7rem; color: #444; margin-bottom: 5px; letter-spacing: 1px; font-weight: bold;}
        .hidden { display: none !important; }
        .label { font-size: 0.7rem; color: #555; text-transform: uppercase; margin-top: 2px; }
    </style>
</head>
<body>

<div id="app">
    <div id="total-clock">00:00</div>
    <div class="label">Tiempo Reanimación</div>

    <div class="cycle-container">
        <div class="status-bar" id="status-label">SISTEMA OFFLINE</div>
        <div id="cycle-clock">02:00</div>
        <div class="label">Ciclo de Compresiones (110 BPM)</div>
    </div>

    <div class="stats-grid">
        <div class="stat-box">
            <span class="stat-label">Inicio</span>
            <span id="res-inicio" class="stat-val">--:--</span>
        </div>
        <div class="stat-box">
            <span class="stat-label">Ciclos</span>
            <span id="res-ciclos" class="stat-val">0</span>
        </div>
        <div class="stat-box">
            <span class="stat-label">Descargas</span>
            <span id="res-descargas" class="stat-val">0</span>
        </div>
    </div>

    <div class="log-panel" id="log-panel">
        <div id="log-empty" style="color: #444; text-align: center; font-size: 0.8rem; padding: 10px;">Dicta fármacos, procedimientos o descargas...</div>
        <div id="log-list"></div>
    </div>

    <button id="start-btn">INICIAR ASISTENTE</button>
    <button id="stop-btn" class="hidden">DETENER RCP</button>
    <button id="copy-btn" class="hidden">COPIAR BITÁCORA</button>
    <button id="reset-btn" class="hidden">NUEVO PACIENTE</button>
</div>

<script>
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
let totalSec = 0, isRunning = false, numCiclos = 0, numDescargas = 0, logData = [];
let totalTimer, cycleTimer, tackTimer, recognition;

const DICTIONARY = [
    { keys: ['adrenalina', 'epinefrina'], label: 'ADRENALINA' },
    { keys: ['amiodarona'], label: 'AMIODARONA' },
    { keys: ['lidocaina'], label: 'LIDOCAÍNA' },
    { keys: ['atropina'], label: 'ATROPINA' },
    { keys: ['adenosina'], label: 'ADENOSINA' },
    { keys: ['bicarbonato'], label: 'BICARBONATO' },
    { keys: ['calcio', 'gluconato'], label: 'GLUC. CALCIO' },
    { keys: ['potasio'], label: 'POTASIO' },
    { keys: ['magnesio', 'sulfato'], label: 'SULF. MAGNESIO' },
    { keys: ['intuba', 'endotraqueal', 'tubo'], label: 'INTUBACIÓN ET' },
    { keys: ['canaliza', 'periferica', 'via venosa'], label: 'VÍA PERIFÉRICA' },
    { keys: ['central', 'subclavia', 'yugular'], label: 'CATÉTER CENTRAL' },
    { keys: ['desfibrila', 'descarga', 'choque'], label: 'DESFIBRILACIÓN', isShock: true },
    { keys: ['cardiover'], label: 'CARDIOVERSIÓN' }
];

if ('webkitSpeechRecognition' in window) {
    recognition = new webkitSpeechRecognition();
    recognition.continuous = true;
    recognition.lang = 'es-ES';
    recognition.onresult = (e) => {
        const res = e.results[e.results.length - 1][0].transcript.toLowerCase();
        DICTIONARY.forEach(item => {
            if (item.keys.some(k => res.includes(k))) {
                if (item.isShock) {
                    numDescargas++;
                    document.getElementById('res-descargas').innerText = numDescargas;
                }
                registrarEvento(item.label);
            }
        });
    };
    recognition.onend = () => { if(isRunning) recognition.start(); };
}

function registrarEvento(label) {
    const t = formatTime(totalSec);
    logData.push({ time: t, event: label });
    const list = document.getElementById('log-list');
    if (document.getElementById('log-empty')) document.getElementById('log-empty').remove();
    const div = document.createElement('div');
    div.className = 'log-item';
    div.innerHTML = `<span class="log-name">${label}</span> <span class="log-time">Min ${t}</span>`;
    list.prepend(div);
    confirmacion();
}

function confirmacion() {
    const n = audioCtx.currentTime;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.connect(g); g.connect(audioCtx.destination);
    o.frequency.setValueAtTime(1400, n);
    g.gain.setValueAtTime(0.05, n);
    o.start(n); o.stop(n + 0.05);
}

function playBeep() {
    const n = audioCtx.currentTime;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.connect(g); g.connect(audioCtx.destination);
    o.frequency.setValueAtTime(1000, n);
    g.gain.setValueAtTime(0.2, n);
    g.gain.exponentialRampToValueAtTime(0.001, n + 0.1);
    o.start(n); o.stop(n + 0.1);
}

function decir(txt) {
    window.speechSynthesis.cancel();
    const m = new SpeechSynthesisUtterance(txt);
    m.lang = 'es-ES';
    window.speechSynthesis.speak(m);
}

const iniciar = async () => {
    if (isRunning) return;
    if (audioCtx.state === 'suspended') await audioCtx.resume();
    isRunning = true;
    document.getElementById('res-inicio').innerText = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    document.getElementById('start-btn').classList.add('hidden');
    document.getElementById('stop-btn').classList.remove('hidden');
    document.getElementById('status-label').innerText = "ESCUCHANDO...";
    document.getElementById('status-label').style.color = "#2ecc71";
    
    if(recognition) recognition.start();

    totalTimer = setInterval(() => {
        totalSec++;
        document.getElementById('total-clock').innerText = formatTime(totalSec);
    }, 1000);

    const ciclo = () => {
        let s = 120;
        tackTimer = setInterval(playBeep, 545);
        cycleTimer = setInterval(() => {
            s--;
            document.getElementById('cycle-clock').innerText = formatTime(s);
            if(s === 5) decir("Cambio en cinco segundos");
            if(s <= 0) {
                clearInterval(cycleTimer); clearInterval(tackTimer);
                numCiclos++;
                document.getElementById('res-ciclos').innerText = numCiclos;
                decir("Cambio. Evalúe ritmo.");
                setTimeout(() => { if(isRunning) ciclo(); }, 5000);
            }
        }, 1000);
    };
    ciclo();
};

const detener = () => {
    isRunning = false;
    clearInterval(totalTimer); clearInterval(cycleTimer); clearInterval(tackTimer);
    if(recognition) recognition.stop();
    document.getElementById('status-label').innerText = "REGISTRO FINALIZADO";
    document.getElementById('status-label').style.color = "#e74c3c";
    document.getElementById('stop-btn').classList.add('hidden');
    document.getElementById('copy-btn').classList.remove('hidden');
    document.getElementById('reset-btn').classList.remove('hidden');
};

const formatTime = (s) => `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;

document.getElementById('start-btn').onclick = iniciar;
document.getElementById('stop-btn').onclick = detener;
document.getElementById('reset-btn').onclick = () => location.reload();
document.getElementById('copy-btn').onclick = () => {
    let txt = `RESUMEN RCP\n------------------\nHora Inicio: ${document.getElementById('res-inicio').innerText}\nDuración: ${document.getElementById('total-clock').innerText}\nCiclos: ${numCiclos}\nDescargas: ${numDescargas}\n\nBITÁCORA DE EVENTOS:\n`;
    logData.slice().reverse().forEach(e => txt += `[${e.time}] ${e.event}\n`);
    navigator.clipboard.writeText(txt);
    alert("Resumen clínico copiado al portapapeles");
};
</script>
</body>
</html>
