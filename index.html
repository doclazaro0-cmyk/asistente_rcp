<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RCP Pro v5 - Smart Dosing</title>
    <style>
        body { background: #000; color: white; font-family: -apple-system, sans-serif; margin: 0; padding: 10px; display: flex; justify-content: center; }
        #app { width: 100%; max-width: 450px; text-align: center; }
        #total-clock { font-size: 3.5rem; font-weight: bold; font-family: monospace; }
        .cycle-container { background: #111; padding: 20px; border-radius: 20px; margin: 10px 0; border: 4px solid #222; }
        #cycle-clock { font-size: 5.5rem; font-weight: bold; color: #00ff00; font-family: monospace; }
        
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 10px; }
        .stat-box { background: #1a1a1a; padding: 10px; border-radius: 10px; border: 1px solid #333; }
        .stat-label { color: #666; font-size: 0.6rem; text-transform: uppercase; display: block; }
        .stat-val { font-weight: bold; font-size: 1rem; color: #fff; }

        #live-log { background: #0a0a0a; border: 1px solid #333; border-radius: 10px; height: 180px; overflow-y: auto; text-align: left; padding: 10px; margin-bottom: 10px; }
        .log-entry { font-size: 0.85rem; border-bottom: 1px solid #222; padding: 6px 0; display: flex; justify-content: space-between; align-items: center; }
        .log-event { color: #3498db; font-weight: bold; text-transform: uppercase; }
        .log-dose { color: #f1c40f; font-weight: bold; margin-left: 5px; }
        .log-time { color: #666; font-size: 0.75rem; }

        button { width: 100%; padding: 20px; font-size: 1.3rem; border-radius: 15px; border: none; font-weight: bold; margin-bottom: 10px; cursor: pointer; }
        #start-btn { background: #27ae60; color: white; }
        #stop-btn { background: #c0392b; color: white; }
        #post-actions { background: #111; padding: 15px; border-radius: 15px; border: 1px solid #444; }
        
        .mic-active { color: #e74c3c; font-size: 0.7rem; animation: blink 1s infinite; margin-bottom: 5px; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
        .hidden { display: none !important; }
        .label { font-size: 0.7rem; color: #555; text-transform: uppercase; }
    </style>
</head>
<body>

<div id="app">
    <div id="total-clock">00:00</div>
    <div class="label">Tiempo Total RCP</div>

    <div class="cycle-container">
        <div id="mic-status" class="mic-active hidden">● ESCUCHANDO ÓRDENES (ADMINISTRAR / DESCARGAR)</div>
        <div id="cycle-clock">02:00</div>
        <div class="label">Ciclo Actual</div>
    </div>

    <div class="stats-grid">
        <div class="stat-box"><span class="stat-label">Inicio</span><span id="t-inicio" class="stat-val">--:--</span></div>
        <div class="stat-box"><span class="stat-label">Fin</span><span id="t-fin" class="stat-val">--:--</span></div>
        <div class="stat-box"><span class="stat-label">Terapia</span><span id="n-choques" class="stat-val" style="color:#e74c3c">0</span></div>
    </div>

    <div id="live-log">
        <div id="empty-log" style="color:#444; text-align:center; font-size:0.8rem; padding-top:60px;">Ej: "Descarga al máximo" o "Aplica 1mg de adrenalina"</div>
    </div>

    <button id="start-btn">INICIAR REANIMACIÓN</button>
    <button id="stop-btn" class="hidden">DETENER REANIMACIÓN</button>

    <div id="post-actions" class="hidden">
        <input type="text" id="p-name" placeholder="Nombre/ID Paciente" style="width:85%; padding:10px; margin-bottom:10px; border-radius:5px; border:1px solid #333; background:#000; color:#fff;">
        <button onclick="saveSession()" style="background:#2ecc71; font-size:1rem; padding:12px;">GUARDAR EN HISTORIAL</button>
        <button onclick="location.reload()" style="background:#444; font-size:1rem; padding:12px;">NUEVO PACIENTE (BORRAR)</button>
    </div>
</div>

<script>
let totalSec = 0, isRunning = false, numShocks = 0, logData = [], wakeLock = null;
let totalTimer, cycleTimer, tackTimer, recognition;
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

const ACTIONS = ['pasa', 'administra', 'aplica', 'pon', 'descarga', 'choque', 'da', 'dispara', 'pásale', 'ponle'];
const MAX_KEYWORDS = ['máximo', 'todo', 'tope', 'full', 'max'];

const DRUGS = [
    { keys: ['adrenalina','epinefrina'], label: 'ADRENALINA' },
    { keys: ['amiodarona'], label: 'AMIODARONA' },
    { keys: ['atropina'], label: 'ATROPINA' },
    { keys: ['adenosina'], label: 'ADENOSINA' },
    { keys: ['bicarbonato'], label: 'BICARBONATO' },
    { keys: ['calcio','gluconato'], label: 'GLUC. CALCIO' },
    { keys: ['lidocaina'], label: 'LIDOCAÍNA' },
    { keys: ['intuba','tubo'], label: 'INTUBACIÓN ET' },
    { keys: ['canaliza','periferica'], label: 'VÍA PERIFÉRICA' },
    { keys: ['desfibrila','descarga','choque'], label: 'DESFIBRILACIÓN', isShock: true },
    { keys: ['cardiover','cardioversión','cardiovierte'], label: 'CARDIOVERSIÓN', isShock: true }
];

if ('webkitSpeechRecognition' in window) {
    recognition = new webkitSpeechRecognition();
    recognition.continuous = true;
    recognition.lang = 'es-ES';
    
    recognition.onresult = (e) => {
        const text = e.results[e.results.length - 1][0].transcript.toLowerCase();
        
        // Solo registrar si hay verbo de acción
        if (!ACTIONS.some(verb => text.includes(verb))) return;

        DRUGS.forEach(item => {
            if (item.keys.some(k => text.includes(k))) {
                let dose = "";
                
                // Lógica de dosis
                const doseMatch = text.match(/\d+/);
                if (doseMatch) {
                    dose = doseMatch[0];
                } else if (item.isShock && MAX_KEYWORDS.some(mk => text.includes(mk))) {
                    dose = "300J"; // Default para "al máximo"
                }
                
                if (item.isShock) {
                    numShocks++;
                    document.getElementById('n-choques').innerText = numShocks;
                }
                
                registrarEvento(item.label, dose);
            }
        });
    };
    recognition.onend = () => { if(isRunning) recognition.start(); };
}

function registrarEvento(label, dose) {
    const time = formatTime(totalSec);
    const doseLabel = dose ? (dose.includes('J') ? `(${dose})` : `(${dose} mg)`) : "";
    logData.push({ time, event: label, dose: doseLabel });
    
    const logDiv = document.getElementById('live-log');
    if (document.getElementById('empty-log')) document.getElementById('empty-log').remove();
    
    const entry = document.createElement('div');
    entry.className = 'log-entry';
    entry.innerHTML = `<span><span class="log-event">${label}</span><span class="log-dose">${doseLabel}</span></span><span class="log-time">${time}</span>`;
    logDiv.prepend(entry);
    
    const o = audioCtx.createOscillator(); o.connect(audioCtx.destination);
    o.frequency.setValueAtTime(1500, audioCtx.currentTime); o.start(); o.stop(audioCtx.currentTime + 0.05);
}

const formatTime = (s) => `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;

document.getElementById('start-btn').onclick = async () => {
    if (audioCtx.state === 'suspended') await audioCtx.resume();
    isRunning = true;
    if ('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen');
    
    document.getElementById('t-inicio').innerText = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    document.getElementById('start-btn').classList.add('hidden');
    document.getElementById('stop-btn').classList.remove('hidden');
    document.getElementById('mic-status').classList.remove('hidden');
    
    if(recognition) recognition.start();

    totalTimer = setInterval(() => {
        totalSec++;
        document.getElementById('total-clock').innerText = formatTime(totalSec);
    }, 1000);

    const ciclo = () => {
        let s = 120;
        tackTimer = setInterval(() => {
            const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
            o.connect(g); g.connect(audioCtx.destination);
            o.frequency.setValueAtTime(1000, audioCtx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime+0.1);
            o.start(); o.stop(audioCtx.currentTime+0.1);
        }, 545);
        cycleTimer = setInterval(() => {
            s--; document.getElementById('cycle-clock').innerText = formatTime(s);
            if(s === 5) { const m = new SpeechSynthesisUtterance("Cambio en 5 segundos"); m.lang = 'es-ES'; window.speechSynthesis.speak(m); }
            if(s <= 0) {
                clearInterval(cycleTimer); clearInterval(tackTimer);
                const m2 = new SpeechSynthesisUtterance("Evalúe ritmo."); m2.lang = 'es-ES'; window.speechSynthesis.speak(m2);
                setTimeout(() => { if(isRunning) ciclo(); }, 5000);
            }
        }, 1000);
    };
    ciclo();
};

document.getElementById('stop-btn').onclick = () => {
    isRunning = false;
    if (wakeLock) wakeLock.release();
    clearInterval(totalTimer); clearInterval(cycleTimer); clearInterval(tackTimer);
    if(recognition) recognition.stop();
    document.getElementById('t-fin').innerText = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    document.getElementById('stop-btn').classList.add('hidden');
    document.getElementById('mic-status').classList.add('hidden');
    document.getElementById('post-actions').classList.remove('hidden');
};

function saveSession() {
    const name = document.getElementById('p-name').value || "S/N";
    const report = { id: Date.now(), patient: name, inicio: document.getElementById('t-inicio').innerText, fin: document.getElementById('t-fin').innerText, duracion: document.getElementById('total-clock').innerText, eventos: logData };
    let history = JSON.parse(localStorage.getItem('rcp_v5') || "[]");
    history.push(report);
    localStorage.setItem('rcp_v5', JSON.stringify(history.filter(x => x.id > Date.now() - 86400000)));
    alert("Guardado en historial de 24h.");
}
</script>
</body>
</html>
