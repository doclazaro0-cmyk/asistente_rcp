<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RCP Pro v6 - Ultra Estable</title>
    <style>
        body { background: #000; color: white; font-family: sans-serif; margin: 0; padding: 10px; }
        #app { max-width: 450px; margin: auto; text-align: center; }
        
        /* Relojes */
        #total-clock { font-size: 3.5rem; font-weight: bold; font-family: monospace; color: #fff; }
        .cycle-box { background: #111; padding: 15px; border-radius: 15px; border: 3px solid #333; margin: 10px 0; }
        #cycle-clock { font-size: 5rem; font-weight: bold; color: #00ff00; font-family: monospace; line-height: 1; }
        
        /* Stats */
        .stats { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; margin: 10px 0; }
        .stat-card { background: #1a1a1a; padding: 8px; border-radius: 8px; border: 1px solid #333; }
        .stat-label { font-size: 0.6rem; color: #888; text-transform: uppercase; }
        .stat-val { font-size: 1rem; font-weight: bold; display: block; }

        /* Bitácora en Vivo */
        #live-log { background: #0a0a0a; border: 1px solid #444; height: 160px; overflow-y: auto; text-align: left; padding: 10px; margin-top: 10px; border-radius: 8px; }
        .log-line { border-bottom: 1px solid #222; padding: 5px 0; display: flex; justify-content: space-between; font-size: 0.9rem; }
        .log-ev { color: #3498db; font-weight: bold; }
        
        /* Botones */
        button { width: 100%; padding: 18px; font-size: 1.2rem; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; margin-top: 10px; }
        #start-btn { background: #27ae60; color: white; }
        #stop-btn { background: #c0392b; color: white; }
        #save-btn { background: #2980b9; color: white; }
        
        /* Historial */
        #history-section { margin-top: 30px; border-top: 1px solid #333; padding-top: 10px; text-align: left; }
        .history-item { background: #111; padding: 10px; border-radius: 8px; margin-bottom: 10px; font-size: 0.8rem; border-left: 4px solid #2ecc71; }
        
        .hidden { display: none !important; }
        .mic-on { color: #e74c3c; font-size: 0.7rem; margin-top: 5px; }
    </style>
</head>
<body>

<div id="app">
    <div id="total-clock">00:00</div>
    <span class="stat-label">Tiempo de Reanimación</span>

    <div class="cycle-box">
        <div id="cycle-clock">02:00</div>
        <div id="mic-label" class="mic-on hidden">● ESCUCHANDO ÓRDENES</div>
    </div>

    <div class="stats">
        <div class="stat-card"><span class="stat-label">Inicio</span><span id="val-inicio" class="stat-val">--:--</span></div>
        <div class="stat-card"><span class="stat-label">Fin</span><span id="val-fin" class="stat-val">--:--</span></div>
        <div class="stat-card"><span class="stat-label">Choques</span><span id="val-choques" class="stat-val" style="color:red">0</span></div>
    </div>

    <div id="live-log"></div>

    <button id="start-btn">INICIAR RCP</button>
    <button id="stop-btn" class="hidden">DETENER RCP</button>
    
    <div id="save-area" class="hidden">
        <input type="text" id="patient-id" placeholder="ID Paciente / Cama" style="width:90%; padding:10px; margin-top:10px; background:#222; color:white; border:1px solid #444; border-radius:8px;">
        <button id="save-btn">GUARDAR EN HISTORIAL 24H</button>
        <button onclick="location.reload()" style="background:#444;">LIMPIAR / NUEVO</button>
    </div>

    <div id="history-section">
        <h3 style="font-size: 1rem; color: #888;">REGISTROS ÚLTIMAS 24H</h3>
        <div id="history-list"></div>
    </div>
</div>

<script>
let totalSec = 0, isRunning = false, shocks = 0, log = [], wakeLock = null;
let tMain, tCycle, tBeep, recognition;
const audio = new (window.AudioContext || window.webkitAudioContext)();

const KEYWORDS = [
    { k: ['adrenalina','epinefrina'], l: 'ADRENALINA 1mg' },
    { k: ['amiodarona'], l: 'AMIODARONA' },
    { k: ['atropina'], l: 'ATROPINA' },
    { k: ['cardiover','cardioversión'], l: 'CARDIOVERSIÓN', s:true },
    { k: ['descarga','choque','desfibrila'], l: 'DESFIBRILACIÓN', s:true },
    { k: ['máximo','tope','full'], l: 'DESC. MÁXIMA (300J)', s:true }
];

if ('webkitSpeechRecognition' in window) {
    recognition = new webkitSpeechRecognition();
    recognition.continuous = true;
    recognition.lang = 'es-ES';
    recognition.onresult = (e) => {
        const text = e.results[e.results.length - 1][0].transcript.toLowerCase();
        KEYWORDS.forEach(item => {
            if (item.k.some(key => text.includes(key))) {
                addLog(item.l, item.s);
            }
        });
    };
    recognition.onend = () => { if(isRunning) recognition.start(); };
}

function addLog(label, isShock) {
    const time = document.getElementById('total-clock').innerText;
    log.push({ t: time, e: label });
    const div = document.getElementById('live-log');
    div.innerHTML = `<div class="log-line"><span class="log-ev">${label}</span><span>Min ${time}</span></div>` + div.innerHTML;
    if(isShock) {
        shocks++;
        document.getElementById('val-choques').innerText = shocks;
    }
}

document.getElementById('start-btn').onclick = async () => {
    isRunning = true;
    document.getElementById('val-inicio').innerText = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    document.getElementById('start-btn').classList.add('hidden');
    document.getElementById('stop-btn').classList.remove('hidden');
    document.getElementById('mic-label').classList.remove('hidden');
    
    if ('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen');
    if(recognition) recognition.start();

    tMain = setInterval(() => {
        totalSec++;
        document.getElementById('total-clock').innerText = `${Math.floor(totalSec/60).toString().padStart(2,'0')}:${(totalSec%60).toString().padStart(2,'0')}`;
    }, 1000);

    const startCycle = () => {
        let s = 120;
        tBeep = setInterval(() => {
            const o = audio.createOscillator(); o.connect(audio.destination);
            o.frequency.setValueAtTime(1000, audio.currentTime);
            o.start(); o.stop(audio.currentTime + 0.1);
        }, 545);
        tCycle = setInterval(() => {
            s--;
            document.getElementById('cycle-clock').innerText = `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;
            if(s <= 0) {
                clearInterval(tCycle); clearInterval(tBeep);
                window.speechSynthesis.speak(new SpeechSynthesisUtterance("Cambio. Evalúe ritmo."));
                setTimeout(() => { if(isRunning) startCycle(); }, 5000);
            }
        }, 1000);
    };
    startCycle();
};

document.getElementById('stop-btn').onclick = () => {
    isRunning = false;
    clearInterval(tMain); clearInterval(tCycle); clearInterval(tBeep);
    if(recognition) recognition.stop();
    if(wakeLock) wakeLock.release();
    document.getElementById('val-fin').innerText = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    document.getElementById('stop-btn').classList.add('hidden');
    document.getElementById('save-area').classList.remove('hidden');
};

document.getElementById('save-btn').onclick = () => {
    const data = {
        id: Date.now(),
        p: document.getElementById('patient-id').value || "S/N",
        i: document.getElementById('val-inicio').innerText,
        f: document.getElementById('val-fin').innerText,
        d: document.getElementById('total-clock').innerText,
        sh: shocks,
        events: log
    };
    let h = JSON.parse(localStorage.getItem('rcp_h') || "[]");
    h.push(data);
    localStorage.setItem('rcp_h', JSON.stringify(h.filter(x => x.id > Date.now() - 86400000)));
    renderHistory();
    document.getElementById('save-area').innerHTML = "<p style='color:#2ecc71'>✓ Guardado en historial</p><button onclick='location.reload()'>NUEVO PACIENTE</button>";
};

function renderHistory() {
    const h = JSON.parse(localStorage.getItem('rcp_h') || "[]");
    const container = document.getElementById('history-list');
    container.innerHTML = h.reverse().map(x => `
        <div class="history-item">
            <b>${x.p}</b> | Duración: ${x.d} | Choques: ${x.sh}<br>
            <small>${x.i} - ${x.f}</small><br>
            <details>
                <summary>Ver Bitácora</summary>
                ${x.events.map(e => `• [${e.t}] ${e.e}`).join('<br>')}
            </details>
        </div>
    `).join('');
}

// Cargar historial al abrir
renderHistory();
</script>
</body>
</html>
