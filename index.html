<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RCP Pro v3 - Estable</title>
    <style>
        body { background: #000; color: white; font-family: -apple-system, sans-serif; margin: 0; padding: 10px; display: flex; justify-content: center; }
        #app { width: 100%; max-width: 450px; text-align: center; }
        
        /* Relojes siempre visibles */
        .timer-section { margin-top: 10px; }
        #total-clock { font-size: 3.5rem; font-weight: bold; font-family: monospace; color: #fff; }
        .cycle-container { background: #111; padding: 20px; border-radius: 20px; margin: 15px 0; border: 4px solid #222; }
        #cycle-clock { font-size: 5.5rem; font-weight: bold; color: #00ff00; font-family: monospace; }
        
        /* Stats */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 15px; }
        .stat-box { background: #1a1a1a; padding: 10px; border-radius: 10px; border: 1px solid #333; }
        .stat-label { color: #666; font-size: 0.6rem; text-transform: uppercase; display: block; }
        .stat-val { font-weight: bold; font-size: 1rem; color: #fff; }

        /* Bitácora en tiempo real */
        #live-log { background: #0a0a0a; border: 1px solid #333; border-radius: 10px; height: 150px; overflow-y: auto; text-align: left; padding: 10px; margin-bottom: 15px; }
        .log-entry { font-size: 0.85rem; border-bottom: 1px solid #222; padding: 4px 0; display: flex; justify-content: space-between; }
        .log-event { color: #3498db; font-weight: bold; }
        .log-time { color: #888; }

        /* Controles */
        button { width: 100%; padding: 20px; font-size: 1.3rem; border-radius: 15px; border: none; cursor: pointer; font-weight: bold; margin-bottom: 10px; }
        #start-btn { background: #27ae60; color: white; }
        #stop-btn { background: #c0392b; color: white; }
        
        /* Sección de Guardado (Post-Evento) */
        #post-event-actions { background: #111; padding: 15px; border-radius: 15px; border: 1px solid #2ecc71; margin-top: 10px; }
        #patient-name { background: #000; border: 1px solid #444; color: white; padding: 12px; width: 85%; border-radius: 8px; margin-bottom: 10px; font-size: 1rem; }
        
        .hidden { display: none !important; }
        .label { font-size: 0.7rem; color: #555; text-transform: uppercase; }
    </style>
</head>
<body>

<div id="app">
    <div class="timer-section">
        <div id="total-clock">00:00</div>
        <div class="label">Tiempo Total (Visible)</div>
    </div>

    <div class="cycle-container">
        <div id="cycle-clock">02:00</div>
        <div class="label">Ciclo Actual</div>
    </div>

    <div class="stats-grid">
        <div class="stat-box"><span class="stat-label">Inicio</span><span id="t-inicio" class="stat-val">--:--</span></div>
        <div class="stat-box"><span class="stat-label">Fin</span><span id="t-fin" class="stat-val">--:--</span></div>
        <div class="stat-box"><span class="stat-label">Choques</span><span id="n-choques" class="stat-val" style="color:red">0</span></div>
    </div>

    <div id="live-log">
        <div id="empty-log" style="color:#444; text-align:center; font-size:0.8rem; padding-top:40px;">Las órdenes detectadas aparecerán aquí...</div>
    </div>

    <button id="start-btn">INICIAR RCP</button>
    <button id="stop-btn" class="hidden">DETENER RCP</button>

    <div id="post-event-actions" class="hidden">
        <input type="text" id="patient-name" placeholder="Nombre/Cama (Opcional)">
        <button onclick="saveToHistory()" style="background:#2ecc71; font-size:1rem; padding:12px;">GUARDAR EN HISTORIAL 24H</button>
        <button onclick="location.reload()" style="background:#444; font-size:1rem; padding:12px;">NUEVO PACIENTE (BORRAR)</button>
    </div>
</div>

<script>
let totalSec = 0, isRunning = false, numDescargas = 0, logData = [], wakeLock = null;
let totalTimer, cycleTimer, tackTimer, recognition;
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

// Diccionario optimizado
const DICTIONARY = [
    { keys: ['adrenalina','epinefrina'], label: 'ADRENALINA' },
    { keys: ['amiodarona'], label: 'AMIODARONA' },
    { keys: ['atropina'], label: 'ATROPINA' },
    { keys: ['adenosina'], label: 'ADENOSINA' },
    { keys: ['bicarbonato'], label: 'BICARBONATO' },
    { keys: ['calcio','gluconato'], label: 'GLUC. CALCIO' },
    { keys: ['potasio'], label: 'POTASIO' },
    { keys: ['magnesio','sulfato'], label: 'SULF. MAGNESIO' },
    { keys: ['intuba','tubo'], label: 'INTUBACIÓN ET' },
    { keys: ['canaliza','periferica','vía'], label: 'VÍA PERIFÉRICA' },
    { keys: ['central'], label: 'CATÉTER CENTRAL' },
    { keys: ['desfibrila','descarga','choque'], label: 'DESFIBRILACIÓN', isShock: true }
];

// Configuración de Voz Continua
if ('webkitSpeechRecognition' in window) {
    recognition = new webkitSpeechRecognition();
    recognition.continuous = true;
    recognition.interimResults = false;
    recognition.lang = 'es-ES';
    
    recognition.onresult = (e) => {
        const text = e.results[e.results.length - 1][0].transcript.toLowerCase();
        DICTIONARY.forEach(item => {
            if (item.keys.some(k => text.includes(k))) {
                if (item.isShock) {
                    numDescargas++;
                    document.getElementById('n-choques').innerText = numDescargas;
                }
                registrarEvento(item.label);
            }
        });
    };
    recognition.onend = () => { if(isRunning) recognition.start(); };
}

function registrarEvento(label) {
    const timeMark = formatTime(totalSec);
    logData.push({ time: timeMark, event: label });
    
    const logDiv = document.getElementById('live-log');
    if (document.getElementById('empty-log')) document.getElementById('empty-log').remove();
    
    const entry = document.createElement('div');
    entry.className = 'log-entry';
    entry.innerHTML = `<span class="log-event">${label}</span> <span class="log-time">Min ${timeMark}</span>`;
    logDiv.prepend(entry);
    
    // Feedback sonoro
    const o = audioCtx.createOscillator(); o.connect(audioCtx.destination);
    o.frequency.setValueAtTime(1200, audioCtx.currentTime); o.start(); o.stop(audioCtx.currentTime + 0.05);
}

const formatTime = (s) => `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;

document.getElementById('start-btn').onclick = async () => {
    if (audioCtx.state === 'suspended') await audioCtx.resume();
    isRunning = true;
    
    // Bloqueo de pantalla
    if ('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen');
    
    document.getElementById('t-inicio').innerText = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    document.getElementById('start-btn').classList.add('hidden');
    document.getElementById('stop-btn').classList.remove('hidden');
    
    if(recognition) recognition.start();

    totalTimer = setInterval(() => {
        totalSec++;
        document.getElementById('total-clock').innerText = formatTime(totalSec);
    }, 1000);

    const correrCiclo = () => {
        let s = 120;
        tackTimer = setInterval(() => {
            const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
            o.connect(g); g.connect(audioCtx.destination);
            o.frequency.setValueAtTime(1000, audioCtx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime+0.1);
            o.start(); o.stop(audioCtx.currentTime+0.1);
        }, 545);

        cycleTimer = setInterval(() => {
            s--;
            document.getElementById('cycle-clock').innerText = formatTime(s);
            if(s === 5) {
                const m = new SpeechSynthesisUtterance("Cambio en 5 segundos");
                m.lang = 'es-ES'; window.speechSynthesis.speak(m);
            }
            if(s <= 0) {
                clearInterval(cycleTimer); clearInterval(tackTimer);
                const m2 = new SpeechSynthesisUtterance("Cambio. Evalúe ritmo.");
                m2.lang = 'es-ES'; window.speechSynthesis.speak(m2);
                setTimeout(() => { if(isRunning) correrCiclo(); }, 5000);
            }
        }, 1000);
    };
    correrCiclo();
};

document.getElementById('stop-btn').onclick = () => {
    isRunning = false;
    if (wakeLock) wakeLock.release();
    clearInterval(totalTimer); clearInterval(cycleTimer); clearInterval(tackTimer);
    if(recognition) recognition.stop();
    
    // Registrar hora de término
    document.getElementById('t-fin').innerText = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    
    // Mostrar acciones finales sin ocultar el reloj
    document.getElementById('stop-btn').classList.add('hidden');
    document.getElementById('post-event-actions').classList.remove('hidden');
};

function saveToHistory() {
    const name = document.getElementById('patient-name').value || "Sin Nombre";
    const report = {
        id: Date.now(),
        patient: name,
        inicio: document.getElementById('t-inicio').innerText,
        fin: document.getElementById('t-fin').innerText,
        duracion: document.getElementById('total-clock').innerText,
        choques: numDescargas,
        eventos: logData
    };
    
    let history = JSON.parse(localStorage.getItem('rcp_24h') || "[]");
    history.push(report);
    // Mantener solo 24h
    const limit = Date.now() - (24 * 60 * 60 * 1000);
    history = history.filter(x => x.id > limit);
    localStorage.setItem('rcp_24h', JSON.stringify(history));
    
    alert("Datos guardados en historial de 24h.");
}
</script>
</body>
</html>
